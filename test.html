<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Background Test</title>
  <style>
    body { font-family: system-ui; background: #1a1a2e; color: #e0e0e0; padding: 2rem; text-align: center; }
    button { font-size: 1.5rem; padding: 1rem 2rem; margin: 1rem; border-radius: 12px; border: none; cursor: pointer; }
    #log { text-align: left; font-size: 0.8rem; margin-top: 2rem; white-space: pre-wrap; color: #8888a8; }
  </style>
</head>
<body>
  <h2>iOS Background Audio Test</h2>
  <p>Tap play, then lock the screen.</p>

  <audio id="audio" loop playsinline src="test-noise.wav"></audio>

  <button id="playBtn">Play</button>
  <button id="stopBtn">Stop</button>

  <div id="log"></div>

  <script>
    const audio = document.getElementById("audio");
    const log = document.getElementById("log");

    function addLog(msg) {
      log.textContent += new Date().toLocaleTimeString() + " " + msg + "\n";
    }

    // Try the Audio Session API if available
    if (navigator.audioSession) {
      navigator.audioSession.type = "playback";
      addLog("audioSession.type set to 'playback'");
    } else {
      addLog("navigator.audioSession not available");
    }

    // Media Session API
    if ("mediaSession" in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: "Brown Noise",
        artist: "HushHush Test",
      });
      navigator.mediaSession.setActionHandler("play", () => { audio.play(); addLog("mediaSession: play"); });
      navigator.mediaSession.setActionHandler("pause", () => { audio.pause(); addLog("mediaSession: pause"); });
      addLog("MediaSession handlers registered");
    }

    document.getElementById("playBtn").addEventListener("click", async () => {
      try {
        await audio.play();
        addLog("Playing (duration: " + audio.duration.toFixed(1) + "s)");
        if ("mediaSession" in navigator) {
          navigator.mediaSession.playbackState = "playing";
        }
      } catch (e) {
        addLog("Play error: " + e.message);
      }
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      audio.pause();
      addLog("Stopped");
    });

    // Track visibility changes
    document.addEventListener("visibilitychange", () => {
      addLog("visibility: " + document.visibilityState + " | paused: " + audio.paused);
    });

    addLog("Ready. Audio src: " + audio.src.split("/").pop());
  </script>
</body>
</html>
